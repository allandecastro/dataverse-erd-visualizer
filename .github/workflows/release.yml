name: CD - Create Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 1.0.0.0)'
        required: true

permissions:
  contents: write

jobs:
  build-and-release:
    name: Build & Package Solution
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'

      - name: Get version
        id: version
        shell: bash
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
            echo "IS_TAG=false" >> $GITHUB_OUTPUT
          else
            echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
            echo "TAG_NAME=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
            echo "IS_TAG=true" >> $GITHUB_OUTPUT
          fi

      - name: Update package.json version
        shell: pwsh
        run: |
          $version = "${{ steps.version.outputs.VERSION }}"
          $packageJson = Get-Content "package.json" -Raw | ConvertFrom-Json
          $packageJson.version = $version
          $packageJson | ConvertTo-Json -Depth 100 | Set-Content "package.json" -Encoding UTF8
          Write-Host "package.json version updated to $version"

      - name: Install dependencies
        run: npm ci

      - name: Type check
        run: npx tsc --noEmit

      - name: Build web resources
        run: npm run build:webresource

      - name: Install Power Platform CLI
        uses: microsoft/powerplatform-actions/actions-install@v1

      - name: Update solution version
        shell: pwsh
        run: |
          $version = "${{ steps.version.outputs.VERSION }}"

          # Update Solution.xml with version
          $solutionFile = "solution/src/Other/Solution.xml"
          $xml = [xml](Get-Content $solutionFile -Encoding UTF8)
          $xml.ImportExportXml.SolutionManifest.Version = $version
          $xml.Save($solutionFile)

          Write-Host "Solution version updated to $version"

      - name: Copy web resources to solution
        shell: pwsh
        run: |
          # Copy built files to solution WebResources folder
          $webResourcesPath = "solution/src/WebResources"

          Copy-Item "dist/webresource/adc_dataverseerdvisualizer.html" "$webResourcesPath/adc_dataverseerdvisualizer.html" -Force
          Copy-Item "dist/webresource/adc_dataverseerdvisualizer.js" "$webResourcesPath/adc_dataverseerdvisualizer.js" -Force
          Copy-Item "dist/webresource/adc_dataverseerdvisualizer.css" "$webResourcesPath/adc_dataverseerdvisualizer.css" -Force
          Copy-Item "dist/webresource/adc_dataverseerdvisualizerlogo.svg" "$webResourcesPath/adc_dataverseerdvisualizerlogo.svg" -Force

          Write-Host "Web resources copied successfully"

      - name: Pack managed solution
        shell: pwsh
        run: |
          & $env:POWERPLATFORMTOOLS_PACPATH solution pack --zipfile "DataverseERDVisualizer_${{ steps.version.outputs.VERSION }}_managed.zip" --folder solution/src --packagetype Managed

      - name: Create web resources zip
        shell: pwsh
        run: |
          Compress-Archive -Path "dist/webresource/*" -DestinationPath "webresources_${{ steps.version.outputs.VERSION }}.zip"

      - name: Upload managed solution artifact
        uses: actions/upload-artifact@v6
        with:
          name: DataverseERDVisualizer_${{ steps.version.outputs.VERSION }}_managed
          path: DataverseERDVisualizer_${{ steps.version.outputs.VERSION }}_managed.zip
          retention-days: 90
          if-no-files-found: error

      - name: Upload web resources artifact
        uses: actions/upload-artifact@v6
        with:
          name: webresources_${{ steps.version.outputs.VERSION }}
          path: webresources_${{ steps.version.outputs.VERSION }}.zip
          retention-days: 90
          if-no-files-found: error

      - name: Create GitHub Release
        if: steps.version.outputs.IS_TAG == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.TAG_NAME }}
          name: Dataverse ERD Visualizer v${{ steps.version.outputs.VERSION }}
          body: |
            ## Dataverse ERD Visualizer v${{ steps.version.outputs.VERSION }}

            ### Downloads

            | File | Description |
            |------|-------------|
            | `DataverseERDVisualizer_${{ steps.version.outputs.VERSION }}_managed.zip` | **Managed Solution** - Recommended for production |
            | `webresources_${{ steps.version.outputs.VERSION }}.zip` | Web resources only (for manual deployment) |

            ### Installation

            1. Download `DataverseERDVisualizer_${{ steps.version.outputs.VERSION }}_managed.zip`
            2. Go to [make.powerapps.com](https://make.powerapps.com) → **Solutions** → **Import solution**
            3. Upload and import the solution
            4. Add the app to your Model-Driven App sitemap

            ---

            See the [Changelog](https://github.com/allandecastro/dataverse-erd-visualizer#changelog) for what's new.
          files: |
            DataverseERDVisualizer_${{ steps.version.outputs.VERSION }}_managed.zip
            webresources_${{ steps.version.outputs.VERSION }}.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update README version badge
        if: steps.version.outputs.IS_TAG == 'true'
        shell: pwsh
        run: |
          $version = "${{ steps.version.outputs.VERSION }}"

          # Update version badge in README.md
          $readme = Get-Content "README.md" -Raw
          $readme = $readme -replace 'version-[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+', "version-$version"
          Set-Content "README.md" $readme -Encoding UTF8

          Write-Host "README.md version badge updated to $version"

      - name: Commit and push README update
        if: steps.version.outputs.IS_TAG == 'true'
        shell: bash
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout main
          git add README.md
          git diff --staged --quiet || git commit -m "docs: update version badge to ${{ steps.version.outputs.VERSION }} [skip ci]"
          git push origin main
