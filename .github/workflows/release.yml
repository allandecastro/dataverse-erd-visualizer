name: CD - Create Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 0.1.0)'
        required: true

permissions:
  contents: write

jobs:
  build-and-release:
    name: Build & Package Solution
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Get version
        id: version
        shell: bash
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          fi

      - name: Update package.json version
        shell: pwsh
        run: |
          $version = "${{ steps.version.outputs.VERSION }}"
          $packageJson = Get-Content "package.json" -Raw | ConvertFrom-Json
          $packageJson.version = $version
          $packageJson | ConvertTo-Json -Depth 100 | Set-Content "package.json" -Encoding UTF8
          Write-Host "package.json version updated to $version"

      - name: Install dependencies
        run: npm ci

      - name: Type check
        run: npx tsc --noEmit

      - name: Build web resources
        run: npm run build:webresource

      - name: Install Power Platform CLI
        uses: microsoft/powerplatform-actions/actions-install@v1

      - name: Update solution version
        shell: pwsh
        run: |
          # Convert version to Dataverse format (x.x.x.0)
          $version = "${{ steps.version.outputs.VERSION }}"
          $parts = $version.Split('.')
          if ($parts.Length -eq 3) {
            $dvVersion = "$version.0"
          } else {
            $dvVersion = $version
          }

          # Update Solution.xml with new version
          $solutionFile = "solution/src/Other/Solution.xml"
          $xml = [xml](Get-Content $solutionFile -Encoding UTF8)
          $xml.ImportExportXml.SolutionManifest.Version = $dvVersion
          $xml.Save($solutionFile)

          Write-Host "Solution version updated to $dvVersion"

      - name: Copy web resources to solution
        shell: pwsh
        run: |
          # Copy built files to solution WebResources folder
          $webResourcesPath = "solution/src/WebResources"

          Copy-Item "dist/webresource/index.html" "$webResourcesPath/adc_dataverseerdvisualizer.html" -Force
          Copy-Item "dist/webresource/adc_dataverseerdvisualizer.js" "$webResourcesPath/adc_dataverseerdvisualizer.js" -Force
          Copy-Item "dist/webresource/adc_dataverseerdvisualizer.css" "$webResourcesPath/adc_dataverseerdvisualizer.css" -Force
          Copy-Item "dist/webresource/adc_dataverseerdvisualizerlogo.svg" "$webResourcesPath/adc_dataverseerdvisualizerlogo.svg" -Force

          Write-Host "Web resources copied successfully"

      - name: Pack managed solution
        shell: pwsh
        run: |
          pac solution pack --zipfile "DataverseERDVisualizer_${{ steps.version.outputs.VERSION }}_managed.zip" --folder solution/src --packagetype Managed

      - name: Pack unmanaged solution
        shell: pwsh
        run: |
          pac solution pack --zipfile "DataverseERDVisualizer_${{ steps.version.outputs.VERSION }}_unmanaged.zip" --folder solution/src --packagetype Unmanaged

      - name: Create web resources zip
        shell: pwsh
        run: |
          Compress-Archive -Path "dist/webresource/*" -DestinationPath "webresources_${{ steps.version.outputs.VERSION }}.zip"

      - name: Upload managed solution artifact
        uses: actions/upload-artifact@v4
        with:
          name: managed-solution-${{ steps.version.outputs.VERSION }}
          path: DataverseERDVisualizer_${{ steps.version.outputs.VERSION }}_managed.zip
          retention-days: 90

      - name: Upload unmanaged solution artifact
        uses: actions/upload-artifact@v4
        with:
          name: unmanaged-solution-${{ steps.version.outputs.VERSION }}
          path: DataverseERDVisualizer_${{ steps.version.outputs.VERSION }}_unmanaged.zip
          retention-days: 90

      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          name: Dataverse ERD Visualizer v${{ steps.version.outputs.VERSION }}
          body: |
            ## Dataverse ERD Visualizer v${{ steps.version.outputs.VERSION }}

            ### Downloads

            | File | Description |
            |------|-------------|
            | `DataverseERDVisualizer_${{ steps.version.outputs.VERSION }}_managed.zip` | **Managed Solution** - Recommended for production |
            | `DataverseERDVisualizer_${{ steps.version.outputs.VERSION }}_unmanaged.zip` | Unmanaged Solution - For development/customization |
            | `webresources_${{ steps.version.outputs.VERSION }}.zip` | Web resources only |

            ### Installation

            1. Download `DataverseERDVisualizer_${{ steps.version.outputs.VERSION }}_managed.zip`
            2. Go to [make.powerapps.com](https://make.powerapps.com) → **Solutions** → **Import solution**
            3. Upload and import the solution
            4. The **Dataverse ERD Visualizer** app will be available in your environment

            ---

            See the [Changelog](https://github.com/allandecastro/dataverse-erd-visualizer#changelog) for what's new.
          files: |
            DataverseERDVisualizer_${{ steps.version.outputs.VERSION }}_managed.zip
            DataverseERDVisualizer_${{ steps.version.outputs.VERSION }}_unmanaged.zip
            webresources_${{ steps.version.outputs.VERSION }}.zip
          draft: false
          prerelease: ${{ contains(github.ref, 'beta') || contains(github.ref, 'alpha') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
